---
layout: post
title:  "SQL Injection(magic_quotes_gpc)"
tags: SQL Injection php
---

# 1. magic_quotes_gpc?

php에는 기본적으로 인젝션을 방어하기 위해서 사용되는 옵션이 있습니다. 

바로 magic_quotes_gpc죠. 설정 파일인 php.ini에 기본적으로 true 값으로 존재하고 있습니다.

기능은 Request에서 넘어오는 GET, POST, Cookie 데이터에 addslashes() 처리 합니다.

<aside>
💡 addslashes()?
query injection에 사용될 수 있는 특수문자 앞에 백슬래시(\)를 붙인 문자열을 반환합니다.
적용되는 문자 : single quote(’), double quote(”), back slash(\), NULL(NULL byte)

</aside>

기본적인 시큐어 코딩에 대한 지식이 없는 개발자의 경우 꽤 유용하게 사용될 수 있는 옵션입니다.

근데 php 5.4버전부터 삭제 되었습니다(!). 사실 아직까지 이유를 모르겠습니다. 

5.4 버전(2012년 3월 12)에서 삭제 된 기능을 지금에서야 글을 쓰는 이유는 

처음 구매에서 사용해보는 맥북으로 글쓰기를 연습하고 있기 때문입니다..ㅎㅎ

물론 제거된 기능도 하나 하나 역사를 타고 올라가 배경을 공부하면 

그만큼 백그라운드 지식이 넓어진다고 믿고 있습니다.

# 2. bypass

구글에 널려있는 많은 블로그들은 얘기합니다. 멀티바이트 인코딩 환경에서는 

magic_quotes_gpc는 취약할 수 있다.. 라고요. 그 글들에서 항상 등장하는 함수가 있는데

바로 mb_convert_encoding(자매품 iconv)입니다. 

```jsx
$id = mb_convert_encoding($id, 'utf-8', 'euc-kr');
```

위 예제 처럼 함수 사용 하는걸 보면 첫번째 인자로 선택된 문자열의 인코딩을 변환 해주는 역할을 합니다.

많은 글들을 봐도 멀티바이트 인코딩 환경에서.. 취약하다 라고 하지만 실제로는 인코딩을 변환 해주는 환경이 

아니면 동작하지 않더라구요.. 실제 서비스 환경에서 잘 보이지 않는 취약점이긴합니다만 딱 한번 이라도 재현

된다면 그 자체로 의미가 있다고 생각합니다.

우회방법은 간단합니다.

- id=' → id= \'  이렇게 변환되는 상황

싱글 쿼터 앞에 멀티바이트 인코딩에 사용되는 %a1 ~ %fe 범위에서 입력이 될 경우에

**뒤에 붙는 \(%5C)가 멀티바이트 인코딩에 사용되는 문자 %a1에 잡아먹혀(?) 전혀 새로운 문자가 되어서** 

**싱글 쿼터를 무력화 시키지 못합니다.**

되게 간단하고 쉽죠? 백슬래시의 역할을 제대로 하지 못하게 하는 것이 핵심입니다. 이런 서비스 환경에 따라

취약해질 수도 있기 때문에 php에서 해당 함수를 지양하고 magic_quotes_gpc 옵션을 삭제한게 아닐까 추측되네요!